#!/bin/bash

minecraft_dir=../
curr_user=`tail -n1 $minecraft_dir/white-list.txt`
fd="$minecraft_dir/command_input"
db='/tmp/chaincraft.db'
spectator=""

function process_line() {
    local user_end=0

    if echo $1 | grep -i "$curr_user joined the game"
    then
        echo "tp $spectator $curr_user" > $fd
        return
    fi

    # Detect if user has disconnected
    if echo $1 | grep -i \"$curr_user left the game\"
    then
        local user_end=1
    fi

    #Detect if the user died
    while read text
    do
        if echo $1 | grep -i "$curr_user $text"
        then
            local user_end=1
            break
        fi
    done < death_messages

    if [ $user_end -eq 1 ]
    then
        #Remove them from the whitelist
        echo "whitelist remove $curr_user" > $fd
        echo "kick $curr_user Your turn is over. Thanks for playing" > $fd

        local nextUser = $(sqlite3 "$db" "select * from users limit 1")
        if test -z "$nextUser"; then return; fi

        local userName = $(echo "$nextUser" | cut -d'|' -f3)
        local userEmail = $(echo "$nextUser" | cut -d'|' -f2)

        echo "whitelist add $userId" > $fd
        sqlite3 "$db" "delete from users where handle=\"$userName\""
        sendmail -fnoreply@linode.jmatthews.us "$userEmail" << __ENDEMAIL__
Your turn to play! Connect to linode.jmatthews.us:25565 to play chaincraft.
__ENDEMAIL__
    fi
}

tail -f $minecraft_dir/logs/latest.log | while read l
do
    process_line "$l"
done
